#!/bin/sh

##
# Hooks
env

# Handle boot hocks
if [ "${RAUC_SLOT_CLASS}" = "boot" ]; then
    BOOT_TMP=/tmp/boot-data
    BOOT_MNT=/mnt/boot

    mkdir -p "${BOOT_TMP}"
    if mountpoint "${BOOT_MNT}"; then
        # Backup boot config
        cp -f "${BOOT_MNT}"/*.txt ${BOOT_TMP}/

        # Update
        mcopy -i "${RAUC_IMAGE_NAME}" -svn ::* "${BOOT_MNT}/"

        # Restore boot config
        cp -f "${BOOT_TMP}"/*.txt "${BOOT_MNT}/"
    else
        # Backup boot config
        mcopy -i "${RAUC_SLOT_DEVICE}" -vn ::* "${BOOT_TMP}/"

        # Update
        dd if="${RAUC_IMAGE_NAME}" of="${RAUC_SLOT_DEVICE}"

        # Restore boot config
        mcopy -i "${RAUC_SLOT_DEVICE}" -vn "${BOOT_TMP}"/*.txt ::
    fi

    rm -rf "${BOOT_TMP}"
fi

# Handle spl install
if [ "${RAUC_SLOT_CLASS}" = "spl" ]; then
    DEVICE_CHILD="$(findfs LABEL="hassos-boot")"
    DEVICE_ROOT="/dev/$(lsblk -no pkname "${DEVICE_CHILD}")"

    if sfdisk -dq "${DEVICE_ROOT}" | grep -q 'label: gpt'; then
        dd if="${RAUC_IMAGE_NAME}" of="${DEVICE_ROOT}" conv=notrunc bs=512 seek=2 skip=2
    else
        dd if="${RAUC_IMAGE_NAME}" of="${DEVICE_ROOT}" conv=notrunc bs=1 count=440
        dd if="${RAUC_IMAGE_NAME}" of="${DEVICE_ROOT}" conv=notrunc bs=512 seek=1 skip=1
    fi
fi

##
# Fixups


exit 0
